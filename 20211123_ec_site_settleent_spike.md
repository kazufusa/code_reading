# resolve spike of settlements

https://logmi.jp/tech/articles/324990

- 商品在庫引当と決済完了までを, 商品の悲観的ロックを伴う一つのトランザクションでまかなっていた
    - 結果, 注文殺到すると待ち時間が増えた
- 在庫確保テーブルを追加し、商品在庫引当トランザクションでの処理を在庫確保と在庫減算のみとした.
    - 決済トランザクションでは在庫確保レコードを削除し注文を確定する
- 決済に失敗した場合は, 補償トランザクション(マイクロサービスのsagaパターン)で在庫確保レコードを削除する.
    - 補償トランザクションが失敗することもあり得るので, 古い在庫確保レコードを削除するバッチ処理も追加した.
- 決済スパイクは解消されたが, 次のボトルネックとしてslimレンダリングが検知された.
    - to be continued...
